import streamlit as st
import requests
import json
import re
from datetime import datetime

st.set_page_config(page_title="TaskMaster IA", page_icon="üß†")

# --- Funci√≥n para consultar a Gemini ---
def consultar_gemini(prompt_usuario):
    url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"
    headers = {"Content-Type": "application/json"}
    params = {"key": st.secrets["GEMINI_API_KEY"]}
    data = {
        "contents": [{
            "parts": [{"text": prompt_usuario}]
        }]
    }
    response = requests.post(url, headers=headers, params=params, json=data)

    if response.status_code == 200:
        respuesta = response.json()
        return respuesta["candidates"][0]["content"]["parts"][0]["text"]
    else:
        return f"‚ùå Error {response.status_code}: {response.text}"

# --- Inicializar sesi√≥n ---
if "tareas" not in st.session_state:
    st.session_state.tareas = []

# --- Agregar nueva tarea ---
st.title("üß† TaskMaster IA")
st.write("Organiz√° tu d√≠a con inteligencia artificial. Pod√©s ingresar tareas con o sin horario, y la IA completar√° lo que falta.")

if st.button("‚ûï Agregar nueva tarea"):
    st.session_state.tareas.append({"descripcion": "", "inicio": "", "fin": ""})

# --- Mostrar tareas cargadas din√°micamente ---
st.subheader("üìã Lista de tareas")

for i, tarea in enumerate(st.session_state.tareas):
    col1, col2, col3 = st.columns([3, 1.5, 1.5])
    tarea["descripcion"] = col1.text_input(f"Tarea #{i+1}", tarea["descripcion"], key=f"desc_{i}")
    tarea["inicio"] = col2.text_input(f"Inicio", tarea["inicio"], key=f"ini_{i}", placeholder="hh:mm")
    tarea["fin"] = col3.text_input(f"Fin", tarea["fin"], key=f"fin_{i}", placeholder="hh:mm")

# --- Bot√≥n de an√°lisis ---
if st.button("üß† Organizar cronograma"):
    tareas_con_horario = []
    tareas_sin_horario = []

    for t in st.session_state.tareas:
        if t["descripcion"].strip() == "":
            continue
        if t["inicio"].strip() and t["fin"].strip():
            tareas_con_horario.append(t)
        else:
            tareas_sin_horario.append(t)

    prompt_horarios = "Tengo las siguientes tareas con horario definido:\n"
    for t in tareas_con_horario:
        prompt_horarios += f"- {t['descripcion']} de {t['inicio']} a {t['fin']}\n"

    if tareas_sin_horario:
        prompt_horarios += "\nY estas tareas sin horario:\n"
        for t in tareas_sin_horario:
            prompt_horarios += f"- {t['descripcion']}\n"
        prompt_horarios += "\nPor favor, asignales un horario a las tareas sin superponerlas con las ya definidas. Manten√© bloques razonables y ordenados."

        resultado_cronograma = consultar_gemini(prompt_horarios)
    else:
        resultado_cronograma = "Todas las tareas tienen horario asignado."

    # --- Mostrar cronograma final ---
    st.subheader("üóìÔ∏è Cronograma sugerido")
    st.markdown(resultado_cronograma)

    # --- Tambi√©n pedir an√°lisis y prioridad ---
    todas_las_tareas = "\n".join([f"- {t['descripcion']}" for t in st.session_state.tareas])
    prompt_prioridad = f"""
Actu√° como un asistente de productividad. Analiz√° estas tareas y asignales una prioridad (Alta, Media, Baja) con una breve justificaci√≥n.
Tareas:
{todas_las_tareas}
"""
    resultado_prioridad = consultar_gemini(prompt_prioridad)

st.subheader("üìå An√°lisis y prioridades con colores")

# Buscar l√≠neas con patr√≥n tipo: "- Tarea: Prioridad (explicaci√≥n)"
lineas = resultado_prioridad.splitlines()

for linea in lineas:
    if "Alta" in linea:
        color = "#FFCCCC"  # rojo claro
    elif "Media" in linea:
        color = "#FFF2CC"  # amarillo claro
    elif "Baja" in linea:
        color = "#CCFFCC"  # verde claro
    else:
        color = "#F0F0F0"  # gris claro por defecto

    st.markdown(f"<div style='background-color: {color}; padding: 10px; border-radius: 8px; margin-bottom: 5px;'>{linea}</div>", unsafe_allow_html=True)

